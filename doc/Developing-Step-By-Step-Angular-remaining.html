<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
<link type="text/css" rel="stylesheet" href="bootstrap.min.css" />
<title>DOCUMENTS</title>
</head>

<body>

<h3>Edit Mode For People List</h3>
<p>Final UI is shown below:</p>
<p>
<img class="img-thumbnail" alt="Phone book edit mode" height="642" src="images/phone-book-edit-mode.png" width="762" /></p>
<p>When we click the <strong>green edit icon</strong> for a person, it's row is 
expanded and all phone numbers are shown. Then we can delete any number by 
clicking the icon at left. We can add a new phone from the inputs at last line.</p>
<h4>View</h4>
<p>Changes in view are shown below:</p>
<pre lang="xml">&lt;div id=&quot;AllPeopleList&quot; class=&quot;list-group&quot;&gt;
    @foreach (var person in Model.Items)
    {
        &lt;a href=&quot;javascript:;&quot; class=&quot;list-group-item&quot; data-person-id=&quot;@person.Id&quot;&gt;
            &lt;h4 class=&quot;list-group-item-heading&quot;&gt;
                @person.Name @person.Surname

                &lt;span class=&quot;person-buttons&quot;&gt;
<strong>                    &lt;button title=&quot;@L(&quot;Edit&quot;)&quot; class=&quot;btn btn-circle btn-icon-only green edit-person&quot;&gt;
                        &lt;i class=&quot;icon-pencil&quot;&gt;&lt;/i&gt;
                    &lt;/button&gt;
</strong>                    @if (IsGranted(AppPermissions.Pages_Tenant_PhoneBook_DeletePerson))
                    {
                        &lt;button title=&quot;@L(&quot;Delete&quot;)&quot; class=&quot;btn btn-circle btn-icon-only red delete-person&quot; href=&quot;javascript:;&quot;&gt;
                            &lt;i class=&quot;icon-trash&quot;&gt;&lt;/i&gt;
                        &lt;/button&gt;
                    }
                &lt;/span&gt;
            &lt;/h4&gt;
            &lt;p class=&quot;list-group-item-text&quot;&gt;
                @person.EmailAddress
            &lt;/p&gt;
<strong>            &lt;div class=&quot;table-scrollable table-phones&quot;&gt;
                &lt;table class=&quot;table table-hover&quot;&gt;
                    &lt;thead&gt;
                        &lt;tr&gt;
                            &lt;th style=&quot;width:10%&quot;&gt;&lt;/th&gt;
                            &lt;th style=&quot;width:15%&quot;&gt;@L(&quot;Type&quot;)&lt;/th&gt;
                            &lt;th style=&quot;width:75%&quot;&gt;@L(&quot;PhoneNumber&quot;)&lt;/th&gt;
                        &lt;/tr&gt;
                    &lt;/thead&gt;
                    &lt;tbody&gt;
                        @foreach (var phone in person.Phones)
                        {
                            @Html.Partial(&quot;_PhoneRowInPersonList&quot;, new PhoneRowInPersonListViewModel(phone))
                        }
                        &lt;tr&gt;
                            &lt;td&gt;
                                &lt;button class=&quot;btn btn-sm green button-save-phone&quot;&gt;
                                    &lt;i class=&quot;fa fa-floppy-o&quot;&gt;&lt;/i&gt;
                                &lt;/button&gt;
                            &lt;/td&gt;
                            &lt;td&gt;
                                &lt;select name=&quot;Type&quot;&gt;
                                    &lt;option value=&quot;0&quot;&gt;@L(&quot;PhoneType_Mobile&quot;)&lt;/option&gt;
                                    &lt;option value=&quot;1&quot;&gt;@L(&quot;PhoneType_Home&quot;)&lt;/option&gt;
                                    &lt;option value=&quot;2&quot;&gt;@L(&quot;PhoneType_Business&quot;)&lt;/option&gt;
                                &lt;/select&gt;
                            &lt;/td&gt;
                            &lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;Number&quot; /&gt;&lt;/td&gt;
                        &lt;/tr&gt;
                    &lt;/tbody&gt;
                &lt;/table&gt;
            &lt;/div&gt;
</strong>        &lt;/a&gt;
    }
&lt;/div&gt;</pre>
<p>We added an edit button for each person. Then added a table for each person that shows phones of the related person 
and allows adding a new phone. Phones table is only shown if we click the edit 
button. This is implemented using a bit CSS and javascript (we will see in next 
sections).</p>
<p>One important thing here is we rendered phone rows in a <strong>partial view</strong>. 
This is done to make this part re-usable. Because we will use the same partial 
view when we create a new phone. The
<strong>            _PhoneRowInPersonList
</strong>        partial view is here:</p>
<pre lang="xml">
@model Acme.PhoneBook.Web.Areas.App.Models.PhoneBook.PhoneRowInPersonListViewModel
&lt;tr data-phone-id=&quot;@Model.Phone.Id&quot;&gt;
    &lt;td&gt;
        &lt;button class=&quot;btn btn-sm default button-delete-phone&quot;&gt;
            &lt;i class=&quot;icon-trash&quot;&gt;&lt;/i&gt;
        &lt;/button&gt;
    &lt;/td&gt;
    &lt;td&gt;@Model.GetPhoneTypeAsString()&lt;/td&gt;
    &lt;td&gt;@Model.Phone.Number&lt;/td&gt;
&lt;/tr&gt;
</pre>
<p>And the <strong>PhoneRowInPersonListViewModel</strong> is here:</p>
<pre lang="cs">public class PhoneRowInPersonListViewModel
{
    public PhoneInPersonListDto Phone { get; set; }

    public PhoneRowInPersonListViewModel(PhoneInPersonListDto phone)
    {
        Phone = phone;
    }

    public string GetPhoneTypeAsString()
    {
        return LocalizationHelper.GetString(PhoneBookConsts.LocalizationSourceName, &quot;PhoneType_&quot; + Phone.Type);
    }
}</pre>
<h4>Styles</h4>
<p>Changed <strong>Index.less</strong> a bit to adapt to the changed view:</p>
<pre>#AllPeopleList {
    .list-group-item-heading {
<strong>        span.person-buttons {
            float: right;
        }
</strong>    }

<strong>    .table-phones {
        display: none;
    }
</strong>
    .person-editing {
        background-color: #ccffcc;

        h4 {
            font-weight: bold;
        }

<strong>        .table-phones {
            display: table;
        }
</strong>    }
}
</pre>
<h4>Scripts</h4>

<p>Added following codes into <strong>Index.js</strong>:</p>
<pre lang="js">//Edit person button
$(&#39;#AllPeopleList button.edit-person&#39;).click(function (e) {
    e.preventDefault();

    var $listItem = $(this).closest(&#39;.list-group-item&#39;);

    $listItem
        .toggleClass(&#39;person-editing&#39;)
        .siblings().removeClass(&#39;person-editing&#39;);
});

//Save phone button
$(&#39;#AllPeopleList .button-save-phone&#39;).click(function (e) {
    e.preventDefault();
            
    var $phoneEditorRow = $(this).closest(&#39;tr&#39;);

<strong>    abp.ajax({
        url: abp.appPath + &#39;<span lang="en-us">App</span>/PhoneBook/AddPhone&#39;,
        dataType: &#39;html&#39;,
        data: JSON.stringify({
            personId: $phoneEditorRow.closest(&#39;.list-group-item&#39;).attr(&#39;data-person-id&#39;),
            Type: $phoneEditorRow.find(&#39;select[name=Type]&#39;).val(),
            Number: $phoneEditorRow.find(&#39;input[name=Number]&#39;).val()
        })
    }).done(function (result) {
        $(result).insertBefore($phoneEditorRow);
    });</strong>
});

//Delete phone button
$(&#39;#AllPeopleList&#39;).on(&#39;click&#39;, &#39;.button-delete-phone&#39;, function (e) {
    e.preventDefault();

    var $phoneRow = $(this).closest(&#39;tr&#39;);
    var phoneId = $phoneRow.attr(&#39;data-phone-id&#39;);

<strong>    _personService.deletePhone({
        id: phoneId
    }).done(function () {
        abp.notify.success(app.localize(&#39;SuccessfullyDeleted&#39;));
        $phoneRow.remove();
    });</strong>
});</pre>
<p>When click to '<strong>edit person</strong>' button, we simple open/close (<strong>toggle</strong>) 
the phones table of related person by using <strong>css</strong> classes.</p>
<p>In the '<strong>save phone</strong>' button's click, we make an <strong>AJAX</strong> request 
to PhoneBookController's <strong>AddPhone</strong> action. Server returns an 
HTML which is then inserted to the table. That's why we did this part partial 
(We will see PhoneBookController.AddPhone action in the next section).</p>
<p>Lastly, we deleting the phone when clicking to the '<strong>delete phone</strong>' 
button and remove the related phone row (tr) from DOM. Notice the event 
registration here. We used <strong>on</strong> function of jQuery. Thus, the 
selector becomes <strong>live</strong>. That means, if we add new elements to 
the page and any element matches to the selector, it's click event is 
automatically binded.</p>
<h4>AddPhone Action</h4>
<p>We added AddPhone action to the PhoneController as shown below:</p>
<pre lang="cs">[HttpPost]
public async Task&lt;PartialViewResult&gt; AddPhone(AddPhoneInput input)
{
    PhoneInPersonListDto phoneInPersonList = await _personAppService.AddPhone(input);
    var model = new PhoneRowInPersonListViewModel(phoneInPersonList);

    return PartialView(&quot;_PhoneRowInPersonList&quot;, model);
}</pre>
<p>It simply uses PersonAppService.AddPhone and returns <strong>_PhoneRowInPersonList</strong> 
partial view as response. Thus, we directly insert returning value to the table. 
A sample return value is shown below:</p>
<pre lang="xml">&lt;tr data-phone-id=&quot;19&quot;&gt;
    &lt;td&gt;
        &lt;button class=&quot;btn btn-sm default button-delete-phone&quot;&gt;
            &lt;i class=&quot;icon-trash&quot;&gt;&lt;/i&gt;
        &lt;/button&gt;
    &lt;/td&gt;
    &lt;td&gt;Mobile&lt;/td&gt;
    &lt;td&gt;129838172&lt;/td&gt;
&lt;/tr&gt;</pre>
<p>As you see, this can be directly inserted to the table, as we already do.</p>
<h3>Multi Tenancy</h3>
<p>We have built a fully functional application until here. Now, we will see how 
to convert it to a multi-tenant application easily.</p>
<h4>Enable Multi Tenancy</h4>
<p>We disabled multi-tenancy at the begginning of this document. Now, re-enabling it in <strong>PhoneBookCoreModule</strong> class:</p>
<pre lang="cs">Configuration.MultiTenancy.IsEnabled = true;</pre>
<h4>Make Entities Multi Tenant</h4>
<p>In a multi-tenant application, a tenant's entities should be isolated by 
other tenants. For this example project, every tenant should have own phone book 
with isolated people and phone numbers.</p>
<p>When we implement IMustHaveTenant interface, ABP automatically
<a href="http://www.aspnetboilerplate.com/Pages/Documents/Data-Filters">filters 
data</a> based on current Tenant, while retrieving entities from database. So, we should declare that Person entity 
must have a tenant using <strong>IMustHaveTenant</strong> interface:</p>
<pre lang="cs">public class Person : FullAuditedEntity, <strong>IMustHaveTenant</strong>
{
    <strong>public virtual int TenantId { get; set; }
</strong>
    //...other properties
}</pre>
<p>We may want to add IMustHaveTenant interface to also Phone entity. This is 
needed if we directly use phone repository to get phones. In this sample 
project, it's not needed.</p>
<p>Since entities have changed, we should create a new database migration:</p>
<pre>dotnet ef migrations add "Implemented_IMustHaveTenant_For_Person"</pre>
<p>This command creates a new code-first database migration. The migration class 
adds an annotation this is needed for automatic filtering. We don't have to know 
what it is since it's done automatically. And also it adds a TenantId column to 
PbPersons table as shown below:</p>
<pre lang="cs">AddColumn(&quot;dbo.PbPersons&quot;, &quot;TenantId&quot;, c =&gt; c.Int(nullable: false, <strong>defaultValue: 1</strong>));</pre>
<p>I added <strong>defaultValue as 1</strong> to AddColumn options. Thus, 
current people are automatically assigned to <strong>default tenant</strong> 
(default tenant's id is 1).</p>
<p>Now, we can update the database again:</p>
<pre>dotnet ef database update</pre>
<h4>Run The Multi Tenant Application</h4>
<p><strong>It's finished</strong>! We can test the application. Run the project, <strong>login</strong> as 
<strong>host</strong> 
as shown blow:</p>
<p>
<img class="img-thumbnail" alt="Login as host" height="400" src="images/login-as-host.png" width="419" /></p>
<p>Since we enabled multi-tenancy, we see a <strong>Tenancy name </strong>input 
on login form. When we leave it <strong>empty</strong>, we login as a <strong>host user</strong>. 
Default <strong>admin</strong> password is <strong>123qwe</strong>.</p>
<p>After login, we see the <strong>tenant list</strong> which only contains a <strong>default</strong> 
tenant. We can create a new tenant:</p>
<p>
<img class="img-thumbnail" alt="Creating tenant" height="655" src="images/create-tenant-2.png" width="619" /></p>
<p>I created a new tenant named <strong>trio</strong>. Now, tenant list has two 
tenants:</p>
<p>
<img class="img-thumbnail" alt="Tenant list" height="497" src="images/tenant-list-with-2-tenant.png" width="871" /></p>
<p>&nbsp;I can <strong>logout</strong> and 
login as trio <strong>tenant admin</strong>:</p>
<p>
<img alt="Login as tenant" height="404" src="images/login-as-tenant.png" width="420" /></p>
<p>After login, we see that phone book is empty:</p>
<p>
<img alt="Empty phonebook of new tenant" height="210" src="images/phonebook-empty.png" width="791" /></p>
<p>It's empty because trio tenant has a completely islolated people list. You can 
add people here, logout and login as different teants (you can login as default 
tenant for example). You will see that each tenant 
has an isolated phone book and can not see other's people.</p>

<h3>Conclusion</h3>
<p>In this document, we built a complete example that covers most parts of the 
ASP.NET Zero system. We hope that it will help you to build your own 
application.</p>
<p>We intentionally used different approaches for similar tasks to show you 
different styles of development. AspNet Zero provides an architecture but does 
not restrict you. You can make your own style development.</p>
<h4>Source Code</h4>
<p>You should <a href="/Prices">purchase</a> ASP.NET Zero in order to get
<strong>source code</strong>. After purchasing, you can get the sample project 
from private Github repository:
<a href="https://github.com/aspnetzero/aspnet-zero-samples">https://github.com/aspnetzero/aspnet-zero-samples</a></p>

</body>

</html>
