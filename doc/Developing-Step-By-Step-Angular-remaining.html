<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
<link type="text/css" rel="stylesheet" href="bootstrap.min.css" />
<title>DOCUMENTS</title>
</head>

<body>

<p>So, changing the <strong>Index.cshtml</strong> view header as shown below:</p>
<pre lang="js">
@using System.Threading.Tasks
@using Acme.PhoneBook.Web.Areas.App.Startup
@model Acme.PhoneBook.Web.Areas.App.Models.PhoneBook.IndexViewModel

@{
    ViewBag.CurrentPageName = AppPageNames.Tenant.PhoneBook;
}

@section Scripts
{
<strong>    &lt;environment names=&quot;Development&quot;&gt;
        &lt;script src=&quot;~/view-resources/Areas/App/Views/PhoneBook/_CreatePersonModal.js&quot; asp-append-version=&quot;true&quot;&gt;&lt;/script&gt;
        &lt;script src=&quot;~/view-resources/Areas/App/Views/PhoneBook/Index.js&quot; asp-append-version=&quot;true&quot;&gt;&lt;/script&gt;
    &lt;/environment&gt;
</strong>}

&lt;div class=&quot;row margin-bottom-5&quot;&gt;
    &lt;div class=&quot;col-xs-6&quot;&gt;
        &lt;div class=&quot;page-head&quot;&gt;
            &lt;div class=&quot;page-title&quot;&gt;
                &lt;h1&gt;
                    &lt;span&gt;@L(&quot;PhoneBook&quot;)&lt;/span&gt;
                &lt;/h1&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    
    &lt;div class=&quot;col-xs-6 text-right&quot;&gt;
<strong>        &lt;button id=&quot;CreateNewPersonButton&quot; class=&quot;btn btn-primary blue&quot;&gt;&lt;i class=&quot;fa fa-plus&quot;&gt;&lt;/i&gt; @L(&quot;CreateNewPerson&quot;)&lt;/button&gt;</strong>
    &lt;/div&gt;
&lt;/div&gt;

&lt;div class=&quot;portlet light&quot;&gt;
    &lt;div class=&quot;portlet-body&quot;&gt;

        &lt;h3&gt;@L(&quot;AllPeople&quot;)&lt;/h3&gt;

        &lt;div class=&quot;list-group&quot;&gt;
            @foreach (var person in Model.Items)
            {
                &lt;a href=&quot;javascript:;&quot; class=&quot;list-group-item&quot;&gt;
                    &lt;h4 class=&quot;list-group-item-heading&quot;&gt;
                        @person.Name @person.Surname
                    &lt;/h4&gt;
                    &lt;p class=&quot;list-group-item-text&quot;&gt;
                        @person.EmailAddress
                    &lt;/p&gt;
                &lt;/a&gt;
            }
        &lt;/div&gt;

    &lt;/div&gt;
&lt;/div&gt;
</pre>
<p>We included modal's javascript (_CreatePersonModal.js) and a <strong>Index.js</strong> file which is defined as shown below:</p>
<pre lang="js">
(function () {
    $(function () {

        var _createPersonModal = new app.ModalManager({
            viewUrl: abp.appPath + 'App/PhoneBook/CreatePersonModal',
            scriptUrl: abp.appPath + 'view-resources/Areas/App/Views/PhoneBook/_CreatePersonModal.js',
            modalClass: 'CreatePersonModal'
        });

        $('#CreateNewPersonButton').click(function (e) {
            e.preventDefault();
            _createPersonModal.open();
        });

    });
})();
</pre>
<p><strong>ModalManager </strong>is a predefined modal helper javascript class 
of AspNet Zero. It accepts a <strong>viewUrl</strong> (which is actually an MVC 
action to load the view), a <strong>scriptUrl</strong> (javascript file of the 
modal) and a <strong>modalClass</strong> (which is set when we define the modal 
above).</p>
<p>ModalManager's <strong>open</strong> method loads view and javascript (if 
needed) and opens the modal.</p>
<p>Lastly, we should create the MVC action defined as App/PhoneBook/CreatePersonModal. 
So, open the <strong>PhoneBookController</strong> again and add the following action:</p>
<pre lang="js">public PartialViewResult CreatePersonModal()
{
    return PartialView(&quot;_CreatePersonModal&quot;);
}</pre>
<p>Now, we can run the application and open the modal by clicking the 'Create 
New Person' button:</p>
<p>&nbsp;</p>
<h4>Saving The Person</h4>
<p>Finally, we can save the person when user clicks the the save button. We 
implement it in the _CreatePersonModal.js file:</p>
<pre lang="js">(function($) {
    app.modals.CreatePersonModal = function () {

        var _modalManager;
<strong>        var _personService = abp.services.app.person;
        var _$form = null;
</strong>
        this.init = function(modalManager) {
            _modalManager = modalManager;

<strong>            _$form = _modalManager.getModal().find(&#39;form&#39;);
            _$form.validate();
</strong>        };

        this.save = function () {
<strong>            if (!_$form.valid()) {
                return;
            }

            var person = _$form.serializeFormToObject();

            _modalManager.setBusy(true);
            _personService.createPerson(person).done(function () {
                _modalManager.close();
                location.reload();
            }).always(function () {
                _modalManager.setBusy(false);
            });
</strong>        };
    };
})(jQuery);</pre>
<p>In the <strong>init</strong> function, we got a reference to the <strong>form</strong> 
and enable <strong>validation</strong>.</p>
<p>In the <strong>save</strong> method, we first <strong>validate</strong> the
<strong>form</strong>. Then we convert the form to a <strong>javascript object
</strong>(since server waits for JSON). Then we use PersonAppService's <strong>
createPerson</strong> method to save the person. <strong>setBusy</strong> method 
automatically disables save and cancel buttons. In the <strong>done</strong> 
method, we simple <strong>reload</strong>ed the page to show new user in the 
page (In a real application, we could add new person to the page dynamically 
using jQuery)</p>
<p>Notice that; We used PersonAppService's createPerson method directly from 
javascript. This is possible by ABP's
<a href="http://www.aspnetboilerplate.com/Pages/Documents/Dynamic-Web-API">
Dynamic Web API layer</a>.</p>
<h3>Authorization For Phone Book</h3>
<p>At this point, anyone can enter phone book page since no authorization 
defined. We will define two permission:</p>
<ul>
	<li>A permission to <strong>enter phone book page</strong>.</li>
	<li>A permission to <strong>create new person</strong> (which is a child 
	permission of first one, as naturally).</li>
</ul>
<h4>Permission for Entering Phone Book Page</h4>
<h5>Define the permission</h5>
<p>Go to <strong>AppAuthorizationProvider</strong> class and add a new permission as shown below:</p>
<pre lang="cs">pages.CreateChildPermission(AppPermissions.Pages_Tenant_PhoneBook, L(&quot;PhoneBook&quot;), multiTenancySides: MultiTenancySides.Tenant);</pre>
<p>A permission should have a unique name. We define permission names as 
constant strings in <strong>AppPermissions</strong> class. It's a simple constant string:</p>
<pre lang="cs">public const string Pages_Tenant_PhoneBook = &quot;<strong>Pages.Tenant.PhoneBook</strong>&quot;;</pre>
<p>Unique name of this permission is "<strong>Pages.Tenant.PhoneBook</strong>". 
While you can set any string (as long as it's unique), it's suggested this 
convention. A permission can have a localizable display name: "<strong>PhoneBook</strong>" 
here. (see "Adding a New Page" section for more about localization, since it's 
very similar). Lastly, we set that this is a <strong>tenant</strong> level 
permission.</p>
<h5>Add AbpAuthorize attribute</h5>
<p><strong>AbpAuthorize</strong> attribute can be used as <strong>class level</strong> 
or <strong>method level</strong> to protect an application service or service method from 
unauthorized users. Since all server side code is located in PersonAppService 
class, we can declare a class level attribute as shown below:</p>
<pre lang="cs"><strong>[AbpAuthorize(AppPermissions.Pages_Tenant_PhoneBook)]
</strong>public class PersonAppService : PhoneBookAppServiceBase, IPersonAppService
{
    //...
}</pre>
<p>Now, let's try to enter Phone Book page by clicking the menu item:</p>
<p>
<img class="img-thumbnail" alt="500 Error" height="243" src="images/error-500.png" width="614" /></p>
<p>We get an error message. This exception is thrown when any method of 
PersonAppService is called without required permission.</p>
<h5>Hide Unauthorized Menu Item</h5>
<p>This secures the service, but we should also <strong>hide</strong> the Phone book 
<strong>menu item</strong>. It's 
easy, open <strong>AppNavigationProvider</strong> and add requiredPermissionName as shown below:</p>
<pre lang="cs">new MenuItemDefinition(
    PageNames.App.Tenant.PhoneBook,
    L(&quot;PhoneBook&quot;),
    url: &quot;tenant.phonebook&quot;,
    icon: &quot;glyphicon glyphicon-book&quot;,
    <strong>requiredPermissionName: AppPermissions.Pages_Tenant_PhoneBook
</strong>)</pre>
<h5>Grant permission</h5>
<p>So, how we can enter the page now? Simple, go to <strong>Role Management</strong> 
page and edit <strong>admin</strong> role:</p>
<p>
<img class="img-thumbnail" alt="Role permissions" height="574" src="images/role-permissions-with-phonebook.png" width="617" /></p>
<p>We see that a <strong>new permission</strong> named "<strong>Phone book</strong>" 
added to <strong>permissions</strong> tab. So, we can check it and save the 
role. After saving, we need to <strong>refresh </strong>the whole page to 
refresh permissions for the current user. We could also grant this permission 
for a specific user (see <a href="Development-Guide.html">development guide 
document</a> for details about roles and users).</p>
<p>Now, we can enter the Phone book page again.</p>
<h4>Permission for Create New Person</h4>
<p>While a permission for a page is useful and probably needed always, we may 
need to define additional permissions to perform some <strong>specific actions</strong> 
on a page, like creating a new person. </p>
<h5>Define the Permission</h5>
<p>Defining a permission is similar:</p>
<pre lang="cs">var phoneBook = pages.CreateChildPermission(AppPermissions.Pages_Tenant_PhoneBook, L(&quot;PhoneBook&quot;), multiTenancySides: MultiTenancySides.Tenant);
<strong>phoneBook.CreateChildPermission(AppPermissions.Pages_Tenant_PhoneBook_CreatePerson, L(&quot;CreateNewPerson&quot;), multiTenancySides: MultiTenancySides.Tenant);</strong></pre>
<p>First permission was defined before. In the second line, we are creating a 
child permission of first one.</p>
<h5>Add AbpAuthorize Attribute</h5>
<p>This time, we're declaring <strong>AbpAuthorize</strong> attribute just for 
<strong>CreatePerson</strong> 
method:</p>
<pre lang="cs"><strong>[AbpAuthorize(AppPermissions.Pages_Tenant_PhoneBook_CreatePerson)]
</strong>public async Task CreatePerson(CreatePersonInput input)
{
    //...
}
</pre>
<h5>Hide Unauthorized Button</h5>
<p>If we run the application and try to create a person, we get an authorization 
error after clicking the save button. But, it's good to <strong>completely hide 
Create New Person button</strong> if we don't have the permission. It's very 
simple:</p>
<p>Open the <strong>index.cshtml</strong> razor view and use
<strong>IsGranted</strong> 
method:</p>
<pre lang="xml"><strong>@if (IsGranted(AppPermissions.Pages_Tenant_PhoneBook_CreatePerson))
</strong>{
    &lt;button id=&quot;CreateNewPersonButton&quot; class=&quot;btn btn-primary blue&quot;&gt;&lt;i class=&quot;fa fa-plus&quot;&gt;&lt;/i&gt; @L(&quot;CreateNewPerson&quot;)&lt;/button&gt;
}
</pre>
<p>In this way, the "Create New Person" button does not rendered in server and user can 
not see this button.</p>
<h5>Grant permission</h5>
<p>To see the button again, we can go to role or user manager and grant related 
permission as shown below:</p>
<p>
<img class="img-thumbnail" alt="User specific permissions" height="527" src="images/user-permissions-phonebook.png" width="617" /></p>
<p>As shown above, <strong>Create new person</strong> permission is a child 
permission of the <strong>Phone book</strong>.</p>
<h4>Authorization for MVC Controllers</h4>
<p>We added Authorize attrbiutes to PersonAppService. This prevents unauthorized 
calls to this service. But unauthorized clients <strong>still can call </strong>actions of 
PhoneBookController actions. Since PhoneBookController uses PersonAppService, they will 
get authorization exception and can not use the service. But we can also secure MVC Controllers. 
This is suggested since some MVC actions may not use application services. Also, 
it's better to prevent unauthorized attemps at the very beginning.</p>
<p>We use <strong>AbpMvcAuthorize</strong> attribute for MVC Controllers as 
shown below:</p>
<pre lang="cs"><strong>[AbpMvcAuthorize(AppPermissions.Pages_Tenant_PhoneBook)]
</strong>public class PhoneBookController : PhoneBookControllerBase
{
    ...
    
    <strong>[AbpMvcAuthorize(AppPermissions.Pages_Tenant_PhoneBook_CreatePerson)]
</strong>    public PartialViewResult CreatePersonModal()
    {
        ...
    }
    
    ...
}</pre>
<p>See <a href="http://www.aspnetboilerplate.com/Pages/Documents/Authorization">
authorization documentation</a> for more information on authorization.</p>
<h3>Deleting a Person</h3>
<p>Let's add a delete button in people list as shown below:</p>
<p>
<img class="img-thumbnail" alt="Delete person" height="409" src="images/phonebook-people-delete-button.png" width="768" /></p>
<p>
We're starting from UI in this case.</p>
<h4>View</h4>
<p>We're changing <strong>index.cshtml</strong> view to add a button (related part is shown 
here):</p>
<pre lang="xml">&lt;div<strong> id=&quot;AllPeopleList&quot;</strong> class=&quot;list-group&quot;&gt;
    @foreach (var person in Model.Items)
    {
        &lt;a href=&quot;javascript:;&quot; class=&quot;list-group-item&quot; <strong>data-person-id="@person.Id"</strong>&gt;
            &lt;h4 class=&quot;list-group-item-heading&quot;&gt;
                @person.Name @person.Surname
<strong>                @if (IsGranted(AppPermissions.Pages_Tenant_PhoneBook_DeletePerson))
                {
                    &lt;button title=&quot;@L(&quot;Delete&quot;)&quot; class=&quot;btn btn-circle btn-icon-only red delete-person&quot; href=&quot;javascript:;&quot;&gt;
                        &lt;i class=&quot;icon-trash&quot;&gt;&lt;/i&gt;
                    &lt;/button&gt;
                }
</strong>            &lt;/h4&gt;
            &lt;p class=&quot;list-group-item-text&quot;&gt;
                @person.EmailAddress
            &lt;/p&gt;
        &lt;/a&gt;
    }
&lt;/div&gt;</pre>
<p>Surely, we defined 'delete person' permission as like before.</p>
<h4>Style</h4>
<p>We're using a <strong><a href="http://lesscss.org/" target="_blank">LESS</a></strong> style here to take button right. Created 
a file named <strong>index.less</strong> and added following lines:</p>
<pre lang="css">#AllPeopleList {
    .list-group-item-heading {
        button.delete-person {
            float: right;
        }
    }
}
</pre>
<p>And add the sytle to your Index.cshtml page (You can also add minified versions of styles for other environmets like production and staging):</p>
<pre lang="xml">
@section Styles
{
    &lt;environment names=&quot;Development&quot;&gt;
        &lt;link rel=&quot;stylesheet&quot; href=&quot;~/view-resources/Areas/App/Views/PhoneBook/Index.css&quot; asp-append-version=&quot;true&quot; /&gt;
    &lt;/environment&gt;
}
</pre>
<h4>Javascript</h4>
<p>Now, adding code to delete person (to Index.js):</p>
<pre lang="js">var _personService = <strong>abp.services.app.person</strong>;

$(&#39;#AllPeopleList button.delete-person&#39;).click(function (e) {
    e.preventDefault();
    
    var $listItem = <strong>$(this).closest(&#39;.list-group-item&#39;);</strong>
    var personId = $listItem.attr(&#39;<strong>data-person-id</strong>&#39;);

    abp.message.confirm(
        app.localize(&#39;AreYouSureToDeleteThePerson&#39;),
        function(isConfirmed) {
            if (isConfirmed) {
                <strong>_personService.deletePerson</strong>({
                    id: personId
                }).done(function () {
                    abp.notify.info(app.localize(&#39;SuccessfullyDeleted&#39;));
                    <strong>$listItem.remove();</strong>
                });
            }
        }
    );
});</pre>
<p>It first shows a confirmation message when we click the delete button:</p>
<p>
<img class="img-thumbnail" alt="Confirmation message" height="338" src="images/confirmation-delete-person.png" width="493" /></p>
<p>If we click Yes, it simply calls <strong>deletePerson</strong> method of 
<strong>PersonAppService</strong> and shows a 
<strong>
<a href="http://www.aspnetboilerplate.com/Pages/Documents/Javascript-API/Notification">notification</a></strong> if operation succeed.&nbsp;Also, 
removes the person from the page using jQuery's <strong>remove</strong> 
function.</p>
<h4>Application Service</h4>
<p>First, adding a new method definition to <strong>IPersonAppService</strong> interface as always:</p>
<pre lang="cs">Task DeletePerson(EntityDto input);</pre>
<p><strong>EntityDto</strong> is a shortcut of ABP if we only get an id value. Implementation (in 
<strong>PersonAppService</strong>) is very simple:</p>
<pre lang="cs">[AbpAuthorize(AppPermissions.Pages_Tenant_PhoneBook_DeletePerson)]
public async Task DeletePerson(EntityDto input)
{
    await _personRepository.DeleteAsync(input.Id);
}</pre>
<p>We also <strong>authorized</strong> deleting a person as did before for creating a person.</p>
<h3>Filtering people</h3>
<p>Now, we will implement <strong>search</strong> functionality of <strong>
GetPeople</strong> method. UI is shown below:</p>
<p>
<img class="img-thumbnail" alt="Searching people" height="328" src="images/search-people.png" width="770" /></p>
<p>We added a search input to filter people (showing the related part of the 
code):</p>
<pre lang="xml">&lt;div class=&quot;portlet light&quot;&gt;
<strong>    &lt;div class=&quot;portlet-title portlet-title-filter&quot;&gt;

        &lt;h3&gt;@L(&quot;AllPeople&quot;) (@Model.Items.Count)&lt;/h3&gt;

        &lt;div class=&quot;inputs inputs-full-width&quot;&gt;
            &lt;div class=&quot;portlet-input&quot;&gt;
                &lt;form action=&quot;@Url.Action(&quot;Index&quot;)&quot; method=&quot;GET&quot;&gt;
                    &lt;div class=&quot;input-group&quot;&gt;
                        &lt;input id=&quot;FilterPeopleText&quot; name=&quot;Filter&quot; value=&quot;@Model.Filter&quot; class=&quot;form-control&quot; placeholder=&quot;@L(&quot;SearchWithThreeDot&quot;)&quot; type=&quot;text&quot;&gt;
                        &lt;span class=&quot;input-group-btn&quot;&gt;
                            &lt;button id=&quot;FilterPeopleButton&quot; class=&quot;btn default&quot; type=&quot;submit&quot;&gt;&lt;i class=&quot;icon-magnifier&quot;&gt;&lt;/i&gt;&lt;/button&gt;
                        &lt;/span&gt;
                    &lt;/div&gt;
                &lt;/form&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
</strong>
    &lt;div class=&quot;portlet-body&quot;&gt;

        ...

    &lt;/div&gt;
&lt;/div&gt;</pre>
<p>And added Filter property to the IndexViewModel:</p>
<pre lang="cs">[AutoMapFrom(typeof (ListResultDto&lt;PersonListDto&gt;))]
public class IndexViewModel : ListResultDto&lt;PersonListDto&gt;
{
    <strong>public string Filter { get; set; }</strong>

    public IndexViewModel(ListResultDto&lt;PersonListDto&gt; output<strong>, string filter = null</strong>)
    {
        output.MapTo(this);
        <strong>Filter = filter;</strong>
    }
}</pre>
<p>Lastly, changed PhoneBookController's <strong>Index</strong> action to pass 
the <strong>filter</strong> to the IndexViewModel:</p>
<pre lang="cs">public ActionResult Index(GetPeopleInput input)
{
    var output = _personAppService.GetPeople(input);
    var model = new IndexViewModel(output<strong>, input.Filter</strong>);

    return View(model);
}</pre>
<p>That's all, It works! (Notice that; PersonAppService.GetPeople method was 
already using the input.Filter as we implemented it before).</p>
<h3>Extending the Application: Adding Phone Numbers</h3>
<p>Until now, we did not even mention about phone numbers. It's time to extend 
our domain to support <strong>multiple phone numbers</strong> for a person.</p>
<h3>Creating Phone Entity</h3>
<p>Let's start by creating a new Entity, <strong>Phone</strong> in <strong>.Core</strong> 
project:</p>
<pre lang="cs">[Table(&quot;PbPhones&quot;)]
public class Phone : CreationAuditedEntity&lt;long&gt;
{
    public const int MaxNumberLength = 16;

    [ForeignKey(&quot;PersonId&quot;)]
    public virtual Person Person { get; set; }
    public virtual int PersonId { get; set; }

    [Required]
    public virtual PhoneType Type { get; set; }

    [Required]
    [MaxLength(MaxNumberLength)]
    public virtual string Number { get; set; }
}</pre>
<p>Phone entities are stored in <strong>PbPhones</strong> table. It's primary key is <strong>long</strong> 
and inherits creation auditing properties. It has a reference to <strong>Person</strong> entity which owns the phone 
number.</p>
<p>We added a <strong>Phones</strong> collection to the People:</p>
<pre lang="cs">[Table(&quot;PbPersons&quot;)]
public class Person : FullAuditedEntity
{
    //...other properties

    <strong>public virtual ICollection&lt;Phone&gt; Phones { get; set; }</strong>
}</pre>
<p>We have a <strong>PhoneType</strong> enum as shown below:</p>
<pre lang="cs">public enum PhoneType : byte
{
    Mobile,
    Home,
    Business
}</pre>
<p>Lastly, we're also adding a DbSet property for Phone to our DbContext:</p>
<pre lang="cs">public virtual IDbSet&lt;Phone&gt; Phones { get; set; }</pre>
<h3>Adding Database Migration</h3>
<p>Our entity model has changed, so we need to add a new migration:</p>
<p>
<img class="img-thumbnail" alt="Entity Framework Migration" src="images/phonebook-migrations-core-2.png" /></p>
<p>This will create a new code based migration file to create <strong>PbPhones</strong> 
table:</p>
<pre lang="cs">
public partial class Added_Phone : DbMigration
{
    public override void Up()
    {
        CreateTable(
            &quot;dbo.PbPhones&quot;,
            c =&gt; new
                {
                    Id = c.Long(nullable: false, identity: true),
                    PersonId = c.Int(nullable: false),
                    Type = c.Byte(nullable: false),
                    Number = c.String(nullable: false, maxLength: 16),
                    CreationTime = c.DateTime(nullable: false),
                    CreatorUserId = c.Long(),
                })
            .PrimaryKey(t =&gt; t.Id)
            .ForeignKey(&quot;dbo.PbPersons&quot;, t =&gt; t.PersonId, cascadeDelete: true)
            .Index(t =&gt; t.PersonId);
        
    }
    
    public override void Down()
    {
        DropForeignKey(&quot;dbo.PbPhones&quot;, &quot;PersonId&quot;, &quot;dbo.PbPersons&quot;);
        DropIndex(&quot;dbo.PbPhones&quot;, new[] { &quot;PersonId&quot; });
        DropTable(&quot;dbo.PbPhones&quot;);
    }
}
</pre>
<p>Before updating database, we can go to database <strong>seed</strong> code 
and add example <strong>phone numbers</strong> for example people (We renamed 
InitialPeopleCreator.cs to InitialPeopleAndPhoneCreator.cs):</p>
<pre lang="cs">public class InitialPeopleAndPhoneCreator
{
    //...

    public void Create()
    {
        var douglas = _context.Persons.FirstOrDefault(p =&gt; p.EmailAddress == &quot;douglas.adams@fortytwo.net&quot;);
        if (douglas == null)
        {
            _context.Persons.Add(
                new Person
                {
                    Name = &quot;Douglas&quot;,
                    Surname = &quot;Adams&quot;,
                    EmailAddress = &quot;douglas.adams@fortytwo.com&quot;,
<strong>                    Phones = new List&lt;Phone&gt;
                                {
                                    new Phone {Type = PhoneType.Home, Number = &quot;1112242&quot;},
                                    new Phone {Type = PhoneType.Mobile, Number = &quot;2223342&quot;}
                                }
</strong>                });
        }

        var asimov = _context.Persons.FirstOrDefault(p =&gt; p.EmailAddress == &quot;isaac.asimov@foundation.org&quot;);
        if (asimov == null)
        {
            _context.Persons.Add(
                new Person
                {
                    Name = &quot;Isaac&quot;,
                    Surname = &quot;Asimov&quot;,
                    EmailAddress = &quot;isaac.asimov@foundation.org&quot;,
<strong>                    Phones = new List&lt;Phone&gt;
                                {
                                    new Phone {Type = PhoneType.Home, Number = &quot;8889977&quot;}
                                }
</strong>                });
        }
    }
}</pre>
<p>We added two phone number to Douglas, one phone number to Isaac. But if we 
run "dotnet ef database update" now, phones are not inserted since this seed code checks if 
people exists, and does not insert if it's already exists. What's solution? 
Since we haven't deployed yet, we can delete database (or at lease truncate 
people table) and re-create it. I do it.</p>
<p>Now, we are running <strong>dotnet ef database update</strong> command in Command Prompt to re-create database and seed it. You can check database to see
<strong>PbPhones</strong> table and rows.</p>
<h3>Changing GetPeople Method</h3>
<p>We're changing <strong>PersonAppService.GetPeople</strong> method to <strong>
include</strong> phone numbers of people into return value.</p>
<p>First, we're 
changing <strong>PersonListDto</strong> to contain a list of phones:</p>
<pre lang="cs">[AutoMapFrom(typeof(Person))]
public class PersonListDto : FullAuditedEntityDto
{
    public string Name { get; set; }

    public string Surname { get; set; }

    public string EmailAddress { get; set; }

<strong>    public Collection&lt;PhoneInPersonListDto&gt; Phones { get; set; }
</strong>}

<strong>[AutoMapFrom(typeof(Phone))]
public class PhoneInPersonListDto : CreationAuditedEntityDto&lt;long&gt;
</strong>{<strong>
    public PhoneType Type { get; set; }

    public string Number { get; set; }
</strong>}</pre>
<p>So, added also a DTO to transfer phone numbers and mapped from Phone entity. Now, we can change GetPeople method to get Phones from database:</p>
<pre lang="cs">public ListResultDto&lt;PersonListDto&gt; GetPeople(GetPeopleInput input)
{
    var persons = _personRepository
        .GetAll()
<strong>        .Include(p =&gt; p.Phones)
</strong>        .WhereIf(
            !input.Filter.IsNullOrEmpty(),
            p =&gt; p.Name.Contains(input.Filter) ||
                    p.Surname.Contains(input.Filter) ||
                    p.EmailAddress.Contains(input.Filter)
        )
        .OrderBy(p =&gt; p.Name)
        .ThenBy(p =&gt; p.Surname)
        .ToList();

    return new ListResultDto&lt;PersonListDto&gt;(persons.MapTo&lt;List&lt;PersonListDto&gt;&gt;());
}</pre>
<p>We only added <strong>Include</strong> extension method to the query. Rest of 
the codes remains same. Furthermore, it would work without adding this, but much 
slower (since it will lazy load phone numbers for every person seperately).</p>
<h3>AddPhone and DeletePhone Methods</h3>
<p>We are adding two more methods to IPersonAppService interface as shown below:</p>
<pre lang="cs">Task DeletePhone(EntityDto&lt;long&gt; input);
Task&lt;PhoneInPersonListDto&gt; AddPhone(AddPhoneInput input);</pre>
<p>We could create a new, seperated IPhoneAppService. It's your choice. But, we 
can consider Person as an aggregate and add phone related methods here. AddPhoneInput 
DTO is shown below:</p>
<pre lang="cs">[AutoMapTo(typeof(Phone))]
public class AddPhoneInput
{
    [Range(1, int.MaxValue)]
    public int PersonId { get; set; }

    [Required]
    public PhoneType Type { get; set; }

    [Required]
    [MaxLength(Phone.MaxNumberLength)]
    public string Number { get; set; }
}</pre>
<p>Now, we can implement these methods:</p>
<pre lang="cs">public async Task DeletePhone(EntityDto&lt;long&gt; input)
{
    await _phoneRepository.DeleteAsync(input.Id);
}

public async Task&lt;PhoneInPersonListDto&gt; AddPhone([FromBody]AddPhoneInput input)
{
    var person = _personRepository.Get(input.PersonId);

    var phone = input.MapTo&lt;Phone&gt;();
    person.Phones.Add(phone);
            
    await CurrentUnitOfWork.SaveChangesAsync();

    return phone.MapTo&lt;PhoneInPersonListDto&gt;();
}</pre>
<p>(Note: We injected <strong>IRepository&lt;Phone, long&gt;</strong> in the 
constructor and set to _personRepository field)</p>
<p><strong>DeletePhone</strong> method is simple. It only deletes phone with 
given id.</p>
<p><strong>AddPhone</strong> method <strong>gets </strong>the person from 
database and add new phone to person.Phones collection. Then is <strong>save 
changes</strong>. Saving changes causes inserting new added phone to database 
and get it's <strong>Id</strong>. Because, we are returning a DTO that contains 
newly created phone informations including Id. So, it should be assigned before 
mapping in the last line. (Notice that; normally it's not needed to call 
CurrentUnitOfWork.SaveChangesAsync. It's automatically called at the end of the 
method. We called it in the method since we need to save entity and get it's Id 
immediately. See
<a href="http://www.aspnetboilerplate.com/Pages/Documents/Unit-Of-Work#DocAutoSaveChanges">
UOW document</a> for more.)</p>
<p>There may be different approaches for AddPhone method. You can directly work 
with a <strong>phone repository</strong> to insert new phone. They all have 
different pros and cons. It's your choice.</p>
<h3>Edit Mode For People List</h3>
<p>Final UI is shown below:</p>
<p>
<img class="img-thumbnail" alt="Phone book edit mode" height="642" src="images/phone-book-edit-mode.png" width="762" /></p>
<p>When we click the <strong>green edit icon</strong> for a person, it's row is 
expanded and all phone numbers are shown. Then we can delete any number by 
clicking the icon at left. We can add a new phone from the inputs at last line.</p>
<h4>View</h4>
<p>Changes in view are shown below:</p>
<pre lang="xml">&lt;div id=&quot;AllPeopleList&quot; class=&quot;list-group&quot;&gt;
    @foreach (var person in Model.Items)
    {
        &lt;a href=&quot;javascript:;&quot; class=&quot;list-group-item&quot; data-person-id=&quot;@person.Id&quot;&gt;
            &lt;h4 class=&quot;list-group-item-heading&quot;&gt;
                @person.Name @person.Surname

                &lt;span class=&quot;person-buttons&quot;&gt;
<strong>                    &lt;button title=&quot;@L(&quot;Edit&quot;)&quot; class=&quot;btn btn-circle btn-icon-only green edit-person&quot;&gt;
                        &lt;i class=&quot;icon-pencil&quot;&gt;&lt;/i&gt;
                    &lt;/button&gt;
</strong>                    @if (IsGranted(AppPermissions.Pages_Tenant_PhoneBook_DeletePerson))
                    {
                        &lt;button title=&quot;@L(&quot;Delete&quot;)&quot; class=&quot;btn btn-circle btn-icon-only red delete-person&quot; href=&quot;javascript:;&quot;&gt;
                            &lt;i class=&quot;icon-trash&quot;&gt;&lt;/i&gt;
                        &lt;/button&gt;
                    }
                &lt;/span&gt;
            &lt;/h4&gt;
            &lt;p class=&quot;list-group-item-text&quot;&gt;
                @person.EmailAddress
            &lt;/p&gt;
<strong>            &lt;div class=&quot;table-scrollable table-phones&quot;&gt;
                &lt;table class=&quot;table table-hover&quot;&gt;
                    &lt;thead&gt;
                        &lt;tr&gt;
                            &lt;th style=&quot;width:10%&quot;&gt;&lt;/th&gt;
                            &lt;th style=&quot;width:15%&quot;&gt;@L(&quot;Type&quot;)&lt;/th&gt;
                            &lt;th style=&quot;width:75%&quot;&gt;@L(&quot;PhoneNumber&quot;)&lt;/th&gt;
                        &lt;/tr&gt;
                    &lt;/thead&gt;
                    &lt;tbody&gt;
                        @foreach (var phone in person.Phones)
                        {
                            @Html.Partial(&quot;_PhoneRowInPersonList&quot;, new PhoneRowInPersonListViewModel(phone))
                        }
                        &lt;tr&gt;
                            &lt;td&gt;
                                &lt;button class=&quot;btn btn-sm green button-save-phone&quot;&gt;
                                    &lt;i class=&quot;fa fa-floppy-o&quot;&gt;&lt;/i&gt;
                                &lt;/button&gt;
                            &lt;/td&gt;
                            &lt;td&gt;
                                &lt;select name=&quot;Type&quot;&gt;
                                    &lt;option value=&quot;0&quot;&gt;@L(&quot;PhoneType_Mobile&quot;)&lt;/option&gt;
                                    &lt;option value=&quot;1&quot;&gt;@L(&quot;PhoneType_Home&quot;)&lt;/option&gt;
                                    &lt;option value=&quot;2&quot;&gt;@L(&quot;PhoneType_Business&quot;)&lt;/option&gt;
                                &lt;/select&gt;
                            &lt;/td&gt;
                            &lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;Number&quot; /&gt;&lt;/td&gt;
                        &lt;/tr&gt;
                    &lt;/tbody&gt;
                &lt;/table&gt;
            &lt;/div&gt;
</strong>        &lt;/a&gt;
    }
&lt;/div&gt;</pre>
<p>We added an edit button for each person. Then added a table for each person that shows phones of the related person 
and allows adding a new phone. Phones table is only shown if we click the edit 
button. This is implemented using a bit CSS and javascript (we will see in next 
sections).</p>
<p>One important thing here is we rendered phone rows in a <strong>partial view</strong>. 
This is done to make this part re-usable. Because we will use the same partial 
view when we create a new phone. The
<strong>            _PhoneRowInPersonList
</strong>        partial view is here:</p>
<pre lang="xml">
@model Acme.PhoneBook.Web.Areas.App.Models.PhoneBook.PhoneRowInPersonListViewModel
&lt;tr data-phone-id=&quot;@Model.Phone.Id&quot;&gt;
    &lt;td&gt;
        &lt;button class=&quot;btn btn-sm default button-delete-phone&quot;&gt;
            &lt;i class=&quot;icon-trash&quot;&gt;&lt;/i&gt;
        &lt;/button&gt;
    &lt;/td&gt;
    &lt;td&gt;@Model.GetPhoneTypeAsString()&lt;/td&gt;
    &lt;td&gt;@Model.Phone.Number&lt;/td&gt;
&lt;/tr&gt;
</pre>
<p>And the <strong>PhoneRowInPersonListViewModel</strong> is here:</p>
<pre lang="cs">public class PhoneRowInPersonListViewModel
{
    public PhoneInPersonListDto Phone { get; set; }

    public PhoneRowInPersonListViewModel(PhoneInPersonListDto phone)
    {
        Phone = phone;
    }

    public string GetPhoneTypeAsString()
    {
        return LocalizationHelper.GetString(PhoneBookConsts.LocalizationSourceName, &quot;PhoneType_&quot; + Phone.Type);
    }
}</pre>
<h4>Styles</h4>
<p>Changed <strong>Index.less</strong> a bit to adapt to the changed view:</p>
<pre>#AllPeopleList {
    .list-group-item-heading {
<strong>        span.person-buttons {
            float: right;
        }
</strong>    }

<strong>    .table-phones {
        display: none;
    }
</strong>
    .person-editing {
        background-color: #ccffcc;

        h4 {
            font-weight: bold;
        }

<strong>        .table-phones {
            display: table;
        }
</strong>    }
}
</pre>
<h4>Scripts</h4>

<p>Added following codes into <strong>Index.js</strong>:</p>
<pre lang="js">//Edit person button
$(&#39;#AllPeopleList button.edit-person&#39;).click(function (e) {
    e.preventDefault();

    var $listItem = $(this).closest(&#39;.list-group-item&#39;);

    $listItem
        .toggleClass(&#39;person-editing&#39;)
        .siblings().removeClass(&#39;person-editing&#39;);
});

//Save phone button
$(&#39;#AllPeopleList .button-save-phone&#39;).click(function (e) {
    e.preventDefault();
            
    var $phoneEditorRow = $(this).closest(&#39;tr&#39;);

<strong>    abp.ajax({
        url: abp.appPath + &#39;<span lang="en-us">App</span>/PhoneBook/AddPhone&#39;,
        dataType: &#39;html&#39;,
        data: JSON.stringify({
            personId: $phoneEditorRow.closest(&#39;.list-group-item&#39;).attr(&#39;data-person-id&#39;),
            Type: $phoneEditorRow.find(&#39;select[name=Type]&#39;).val(),
            Number: $phoneEditorRow.find(&#39;input[name=Number]&#39;).val()
        })
    }).done(function (result) {
        $(result).insertBefore($phoneEditorRow);
    });</strong>
});

//Delete phone button
$(&#39;#AllPeopleList&#39;).on(&#39;click&#39;, &#39;.button-delete-phone&#39;, function (e) {
    e.preventDefault();

    var $phoneRow = $(this).closest(&#39;tr&#39;);
    var phoneId = $phoneRow.attr(&#39;data-phone-id&#39;);

<strong>    _personService.deletePhone({
        id: phoneId
    }).done(function () {
        abp.notify.success(app.localize(&#39;SuccessfullyDeleted&#39;));
        $phoneRow.remove();
    });</strong>
});</pre>
<p>When click to '<strong>edit person</strong>' button, we simple open/close (<strong>toggle</strong>) 
the phones table of related person by using <strong>css</strong> classes.</p>
<p>In the '<strong>save phone</strong>' button's click, we make an <strong>AJAX</strong> request 
to PhoneBookController's <strong>AddPhone</strong> action. Server returns an 
HTML which is then inserted to the table. That's why we did this part partial 
(We will see PhoneBookController.AddPhone action in the next section).</p>
<p>Lastly, we deleting the phone when clicking to the '<strong>delete phone</strong>' 
button and remove the related phone row (tr) from DOM. Notice the event 
registration here. We used <strong>on</strong> function of jQuery. Thus, the 
selector becomes <strong>live</strong>. That means, if we add new elements to 
the page and any element matches to the selector, it's click event is 
automatically binded.</p>
<h4>AddPhone Action</h4>
<p>We added AddPhone action to the PhoneController as shown below:</p>
<pre lang="cs">[HttpPost]
public async Task&lt;PartialViewResult&gt; AddPhone(AddPhoneInput input)
{
    PhoneInPersonListDto phoneInPersonList = await _personAppService.AddPhone(input);
    var model = new PhoneRowInPersonListViewModel(phoneInPersonList);

    return PartialView(&quot;_PhoneRowInPersonList&quot;, model);
}</pre>
<p>It simply uses PersonAppService.AddPhone and returns <strong>_PhoneRowInPersonList</strong> 
partial view as response. Thus, we directly insert returning value to the table. 
A sample return value is shown below:</p>
<pre lang="xml">&lt;tr data-phone-id=&quot;19&quot;&gt;
    &lt;td&gt;
        &lt;button class=&quot;btn btn-sm default button-delete-phone&quot;&gt;
            &lt;i class=&quot;icon-trash&quot;&gt;&lt;/i&gt;
        &lt;/button&gt;
    &lt;/td&gt;
    &lt;td&gt;Mobile&lt;/td&gt;
    &lt;td&gt;129838172&lt;/td&gt;
&lt;/tr&gt;</pre>
<p>As you see, this can be directly inserted to the table, as we already do.</p>
<h3>Multi Tenancy</h3>
<p>We have built a fully functional application until here. Now, we will see how 
to convert it to a multi-tenant application easily.</p>
<h4>Enable Multi Tenancy</h4>
<p>We disabled multi-tenancy at the begginning of this document. Now, re-enabling it in <strong>PhoneBookCoreModule</strong> class:</p>
<pre lang="cs">Configuration.MultiTenancy.IsEnabled = true;</pre>
<h4>Make Entities Multi Tenant</h4>
<p>In a multi-tenant application, a tenant's entities should be isolated by 
other tenants. For this example project, every tenant should have own phone book 
with isolated people and phone numbers.</p>
<p>When we implement IMustHaveTenant interface, ABP automatically
<a href="http://www.aspnetboilerplate.com/Pages/Documents/Data-Filters">filters 
data</a> based on current Tenant, while retrieving entities from database. So, we should declare that Person entity 
must have a tenant using <strong>IMustHaveTenant</strong> interface:</p>
<pre lang="cs">public class Person : FullAuditedEntity, <strong>IMustHaveTenant</strong>
{
    <strong>public virtual int TenantId { get; set; }
</strong>
    //...other properties
}</pre>
<p>We may want to add IMustHaveTenant interface to also Phone entity. This is 
needed if we directly use phone repository to get phones. In this sample 
project, it's not needed.</p>
<p>Since entities have changed, we should create a new database migration:</p>
<pre>dotnet ef migrations add "Implemented_IMustHaveTenant_For_Person"</pre>
<p>This command creates a new code-first database migration. The migration class 
adds an annotation this is needed for automatic filtering. We don't have to know 
what it is since it's done automatically. And also it adds a TenantId column to 
PbPersons table as shown below:</p>
<pre lang="cs">AddColumn(&quot;dbo.PbPersons&quot;, &quot;TenantId&quot;, c =&gt; c.Int(nullable: false, <strong>defaultValue: 1</strong>));</pre>
<p>I added <strong>defaultValue as 1</strong> to AddColumn options. Thus, 
current people are automatically assigned to <strong>default tenant</strong> 
(default tenant's id is 1).</p>
<p>Now, we can update the database again:</p>
<pre>dotnet ef database update</pre>
<h4>Run The Multi Tenant Application</h4>
<p><strong>It's finished</strong>! We can test the application. Run the project, <strong>login</strong> as 
<strong>host</strong> 
as shown blow:</p>
<p>
<img class="img-thumbnail" alt="Login as host" height="400" src="images/login-as-host.png" width="419" /></p>
<p>Since we enabled multi-tenancy, we see a <strong>Tenancy name </strong>input 
on login form. When we leave it <strong>empty</strong>, we login as a <strong>host user</strong>. 
Default <strong>admin</strong> password is <strong>123qwe</strong>.</p>
<p>After login, we see the <strong>tenant list</strong> which only contains a <strong>default</strong> 
tenant. We can create a new tenant:</p>
<p>
<img class="img-thumbnail" alt="Creating tenant" height="655" src="images/create-tenant-2.png" width="619" /></p>
<p>I created a new tenant named <strong>trio</strong>. Now, tenant list has two 
tenants:</p>
<p>
<img class="img-thumbnail" alt="Tenant list" height="497" src="images/tenant-list-with-2-tenant.png" width="871" /></p>
<p>&nbsp;I can <strong>logout</strong> and 
login as trio <strong>tenant admin</strong>:</p>
<p>
<img alt="Login as tenant" height="404" src="images/login-as-tenant.png" width="420" /></p>
<p>After login, we see that phone book is empty:</p>
<p>
<img alt="Empty phonebook of new tenant" height="210" src="images/phonebook-empty.png" width="791" /></p>
<p>It's empty because trio tenant has a completely islolated people list. You can 
add people here, logout and login as different teants (you can login as default 
tenant for example). You will see that each tenant 
has an isolated phone book and can not see other's people.</p>

<h3>Conclusion</h3>
<p>In this document, we built a complete example that covers most parts of the 
ASP.NET Zero system. We hope that it will help you to build your own 
application.</p>
<p>We intentionally used different approaches for similar tasks to show you 
different styles of development. AspNet Zero provides an architecture but does 
not restrict you. You can make your own style development.</p>
<h4>Source Code</h4>
<p>You should <a href="/Prices">purchase</a> ASP.NET Zero in order to get
<strong>source code</strong>. After purchasing, you can get the sample project 
from private Github repository:
<a href="https://github.com/aspnetzero/aspnet-zero-samples">https://github.com/aspnetzero/aspnet-zero-samples</a></p>

</body>

</html>
